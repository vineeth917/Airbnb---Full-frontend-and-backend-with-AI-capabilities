apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-topic-init
  namespace: airbnb-lab2
  labels:
    app: kafka-init
spec:
  ttlSecondsAfterFinished: 100
  template:
    metadata:
      labels:
        app: kafka-init
    spec:
      restartPolicy: OnFailure
      containers:
      - name: kafka-init
        image: confluentinc/cp-kafka:7.5.0
        command:
        - /bin/bash
        - -c
        - |
          echo "Waiting for Kafka to be ready..."
          sleep 30
          
          echo "Creating Kafka topics..."
          
          # Booking flow topics
          kafka-topics --create \
            --bootstrap-server kafka:9092 \
            --topic booking-requests \
            --partitions 3 \
            --replication-factor 1 \
            --if-not-exists \
            --config retention.ms=604800000
          
          kafka-topics --create \
            --bootstrap-server kafka:9092 \
            --topic booking-updates \
            --partitions 3 \
            --replication-factor 1 \
            --if-not-exists \
            --config retention.ms=604800000
          
          kafka-topics --create \
            --bootstrap-server kafka:9092 \
            --topic booking-confirmations \
            --partitions 3 \
            --replication-factor 1 \
            --if-not-exists \
            --config retention.ms=604800000
          
          kafka-topics --create \
            --bootstrap-server kafka:9092 \
            --topic booking-cancellations \
            --partitions 3 \
            --replication-factor 1 \
            --if-not-exists \
            --config retention.ms=604800000
          
          # Notification topics
          kafka-topics --create \
            --bootstrap-server kafka:9092 \
            --topic user-notifications \
            --partitions 3 \
            --replication-factor 1 \
            --if-not-exists \
            --config retention.ms=604800000
          
          echo "Listing all topics:"
          kafka-topics --list --bootstrap-server kafka:9092
          
          echo "Topic initialization complete!"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"

